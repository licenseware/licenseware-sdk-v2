<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>licenseware.history.history API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>licenseware.history.history</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">import uuid
import inspect
import traceback
from typing import Any
from functools import wraps
from pymongo.collection import Collection
from licenseware import mongodata
from licenseware.mongodata import collection
from licenseware.common.constants import envs
from licenseware.utils.logger import log as logg
from .history_schemas import EntitiesSchema
from .metadata import get_metadata, create_metadata, add_event_id_to_payload
from .step import save_step


def add_entities(
        event_id: str,
        entities: list = None
):
    &#34;&#34;&#34;
    Add reference ids to entities like databases, devices etc
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            entity_id1, entity_id2 = get_some_entities()
            history.add_entities(event_id, entities=[entity_id1, entity_id2])
    ```
    Where `entity_idx` is an uuid4 string.

    &#34;&#34;&#34;
    return mongodata.update(
        schema=EntitiesSchema,
        match={&#39;event_id&#39;: event_id},
        new_data={&#34;entities&#34;: entities},
        append=True,
        collection=envs.MONGO_COLLECTION_HISTORY_NAME
    )


def remove_entities(
        event_id: str,
        entities: list = None
):
    &#34;&#34;&#34;
    Remove reference ids to entities like databases, devices etc from history
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            entity_id1, entity_id2 = get_some_entities()
            history.add_entities(event_id, entities=[entity_id1, entity_id2])
    ```
    Where `entity_idx` is an uuid4 string.

    &#34;&#34;&#34;
    with collection(envs.MONGO_COLLECTION_HISTORY_NAME) as col:
        col: Collection
        updated = col.update_one(
            filter={&#39;event_id&#39;: event_id},
            update={&#39;$pull&#39;: {&#39;entities&#39;: {&#34;$in&#34;: entities}}}
        ).modified_count

    return updated


def log_success(
        func: callable,
        tenant_id: str,
        event_id: str,
        uploader_id: str,
        filepath: str,
        on_success_save: str = None,
        **overflow
):
    &#34;&#34;&#34;
    Log in history a processing success event.
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            # some processing here
            history.log_success(
                func=processing_func,  # for classes use self.func
                tenant_id=tenant_id,
                event_id=event_id,
                uploader_id=uploader_id,
                filepath=filepath,
                on_success_save=&#34;Entities added successfully&#34;
            )
            # some processing here
    ```
    &#34;&#34;&#34;
    func_name = func.__name__
    step = func.__doc__.strip() if func.__doc__ else func.__name__
    func_source = str(inspect.getmodule(func)).split(&#34;from&#34;)[1].strip().replace(&#34;&#39;&#34;, &#34;&#34;).replace(&#34;&gt;&#34;, &#34;&#34;)

    metadata = create_metadata(step, tenant_id, event_id, uploader_id, filepath, func_name, func_source)
    save_step(metadata, None, on_success_save, None)
    return metadata


def log_failure(
        func: callable,
        tenant_id: str,
        event_id: str,
        uploader_id: str,
        filepath: str,
        error_string: str,
        traceback_string: str,
        on_failure_save: str = None,
        **overflow
):
    &#34;&#34;&#34;
    Log in history a processing failure event.
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            # some processing here
            try:
                raise Exception(&#34;Something bad happened&#34;)
            except Exception as error:
                history.log_failure(
                    func=processing_func, # for classes use self.func
                    tenant_id=tenant_id,
                    event_id=event_id,
                    uploader_id=uploader_id,
                    filepath=filepath,
                    error_string=str(error),
                    traceback_string=str(traceback.format_exc())
                )
            # some processing here
    ```

    &#34;&#34;&#34;

    func_name = func.__name__
    step = func.__doc__.strip() if func.__doc__ else func.__name__
    func_source = str(inspect.getmodule(func)).split(&#34;from&#34;)[1].strip().replace(&#34;&#39;&#34;, &#34;&#34;).replace(&#34;&gt;&#34;, &#34;&#34;)

    metadata = create_metadata(step, tenant_id, event_id, uploader_id, filepath, func_name, func_source)
    save_step(metadata, {
        &#39;error&#39;: error_string,
        &#39;traceback&#39;: traceback_string
    }, None, on_failure_save, True)
    return metadata


def log(*dargs, on_success_save: str = None, on_failure_save: str = None, on_failure_return: Any = None):
    &#34;&#34;&#34;
        Log processing events by decorating processing function/methods.

        Usage:
        ```py
            @history.log
            def processing_function(filepath, event_id, uploader_id, tenant_id):
                # some processing here
                return &#34;some data&#34;
        ```

        Parameters: filepath, event_id, uploader_id, tenant_id are REQUIRED!
        Required parameters can be put on self in class like:

        ```py
            class ProcessingClass:

                def __init__(self, event):
                    self.event_id = event[&#34;event_data&#34;][&#34;event_id&#34;]
                    self.uploader_id = event[&#34;event_data&#34;][&#34;uploader_id&#34;]
                    self.tenant_id = event[&#34;event_data&#34;][&#34;tenant_id&#34;]

                @history.log(on_failure_return={})
                def proc_func_within_class(self, filepath):
                    print(f&#34;Processing {filepath}...&#34;)
                    raise Exception(&#34;Something bad happened&#34;)
                    print(&#34;Done!&#34;)
                    return {&#34;k&#34;: &#34;v&#34;}
        ```
        Either way if needed parameters will not be found an error will be raised by history.log decorator.

        param: on_success_save - what to save on history logs if function didn&#39;t raised any errors
        param: on_failure_save - what to save on history logs if function raised error
        param: on_failure_return - if function raised an error return this instead (for safe processing)
        If you want on failure to return None put it as a string `on_failure_return=&#34;None&#34;`
        Ex:
        ```
            @history.log(on_failure_return={})
            def procFunc(*args, **kwargs):
                raise Exception(&#34;Failed&#34;)

            &gt;&gt; print(procFunc())
            &gt;&gt; {}
        ```

    Here is an example on how logging a processing event will look like:

    ```bash

        {
            _id: ObjectId(&#39;6230670a96defb313cf63fa9&#39;),
            uploader_id: &#39;universal_uploader&#39;,
            app_id: &#39;app&#39;,
            event_id: &#39;6cd474cd-663f-4d1f-891e-e18d0d0ea77e&#39;,
            tenant_id: &#39;b37761e3-6926-4cc1-88c7-4d0478b04adf&#39;,
            filename_validation: [
                {
                    message: &#39;Filename is valid&#39;,
                    filename: &#39;cpuq.txt&#39;,
                    status: &#39;success&#39;
                }
            ],
            updated_at: &#39;2022-03-15T10:14:34.470253&#39;,
            filename_validation_updated_at: &#39;2022-03-15T10:14:34.411491&#39;,
            file_content_validation: [
                {
                    message: &#39;Filename is valid&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;,
                    filename: &#39;cpuq.txt&#39;,
                    status: &#39;success&#39;
                }
            ],
            file_content_validation_updated_at: &#39;2022-03-15T10:14:34.426705&#39;,
            files_uploaded: [
                &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf_6cd474cd-663f-4d1f-891e-e18d0d0ea77e_2022-04-14/cpuq.txt&#39;
            ],
            processing_details: [
                {
                    step: &#39;Getting some data out of provided cpuq.txt file&#39;,
                    status: &#39;success&#39;,
                    traceback: null,
                    error: null,
                    callable: &#39;processing_function&#39;,
                    success: null,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.434117&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                },
                {
                    step: &#39;Getting some data out of provided cpuq.txt file&#39;,
                    status: &#39;success&#39;,
                    traceback: null,
                    error: null,
                    callable: &#39;processing_function_without_decorator&#39;,
                    success: &#39;Entities added successfully&#39;,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.454749&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                },
                {
                    step: &#39;Getting some data out of provided cpuq.txt file&#39;,
                    status: &#39;failed&#39;,
                    traceback: &#39;Traceback (most recent call last):\n  File &#34;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#34;, line 183, in processing_function_without_decorator\n    raise Exception(&#34;Something bad happened&#34;)\nException: Something bad happened\n&#39;,
                    error: &#39;Something bad happened&#39;,
                    callable: &#39;processing_function_without_decorator&#39;,
                    success: null,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.462103&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                },
                {
                    step: &#39;proc_func_within_class&#39;,
                    status: &#39;failed&#39;,
                    traceback: &#39;Traceback (most recent call last):\n  File &#34;/home/acmt/Documents/lware/licenseware-sdk-v2/licenseware/history/history.py&#34;, line 231, in wrapper\n    response = f(*args, **kwargs)\n  File &#34;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#34;, line 219, in proc_func_within_class\n    raise Exception(&#34;Something bad happened&#34;)\nException: Something bad happened\n&#39;,
                    error: &#39;Something bad happened&#39;,
                    callable: &#39;proc_func_within_class&#39;,
                    success: null,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.470259&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                }
            ],
            entities: [
                &#39;5a5be275-cee8-44a6-a11c-0e2b886a820e&#39;,
                &#39;b137ff5d-90f1-4d45-872d-91b617666b78&#39;,
                &#39;b3d7a18e-7a6d-4296-8fcc-0464ec243658&#39;,
                &#39;ebaf16c9-4d88-413d-b395-92b65166ab20&#39;
            ]
        }
    ```

    &#34;&#34;&#34;
    def _decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            print(f&#34;History kwargs: on_success_save:{on_success_save}, on_failure_save:{on_failure_save}, on_failure_return:{on_failure_return}&#34;)
            # Handle case where files are uploaded and event_id is not provided in the query params
            if f.__name__ == &#39;upload_files&#39; and len(args) &gt; 1:
                if hasattr(args[1], &#34;args&#34;):
                    if args[1].args.get(&#34;event_id&#34;) is None:
                        logg.info(&#34;event_id not provided from frontend.\nUpdated with `event_id`.&#34;)
                        kwargs.update({&#34;event_id&#34;: str(uuid.uuid4())})

            metadata = get_metadata(f, args, kwargs)
            try:
                response = f(*args, **kwargs)
                save_step(metadata, response, on_success_save, on_failure_save)
                response = add_event_id_to_payload(metadata, response)
                return response
            except Exception as err:

                save_step(metadata, {
                    &#39;error&#39;: str(err),
                    &#39;traceback&#39;: str(traceback.format_exc())
                }, on_success_save, on_failure_save, True)

                if on_failure_return is not None:
                    return on_failure_return
                elif on_failure_return == &#34;None&#34;:
                    return None
                else:
                    logg.exception(err)
                    raise err

        return wrapper
    return _decorator(dargs[0]) if dargs and callable(dargs[0]) else _decorator</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="licenseware.history.history.add_entities"><code class="name flex">
<span>def <span class="ident">add_entities</span></span>(<span>event_id: str, entities: list = None)</span>
</code></dt>
<dd>
<div class="desc"><p>Add reference ids to entities like databases, devices etc
Usage:</p>
<pre><code class="language-py">    def processing_func(*args, **kwargs):
        entity_id1, entity_id2 = get_some_entities()
        history.add_entities(event_id, entities=[entity_id1, entity_id2])
</code></pre>
<p>Where <code>entity_idx</code> is an uuid4 string.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_entities(
        event_id: str,
        entities: list = None
):
    &#34;&#34;&#34;
    Add reference ids to entities like databases, devices etc
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            entity_id1, entity_id2 = get_some_entities()
            history.add_entities(event_id, entities=[entity_id1, entity_id2])
    ```
    Where `entity_idx` is an uuid4 string.

    &#34;&#34;&#34;
    return mongodata.update(
        schema=EntitiesSchema,
        match={&#39;event_id&#39;: event_id},
        new_data={&#34;entities&#34;: entities},
        append=True,
        collection=envs.MONGO_COLLECTION_HISTORY_NAME
    )</code></pre>
</details>
</dd>
<dt id="licenseware.history.history.log"><code class="name flex">
<span>def <span class="ident">log</span></span>(<span>*dargs, on_success_save: str = None, on_failure_save: str = None, on_failure_return: Any = None)</span>
</code></dt>
<dd>
<div class="desc"><p>Log processing events by decorating processing function/methods.</p>
<pre><code>    Usage:
    ```py
        @history.log
        def processing_function(filepath, event_id, uploader_id, tenant_id):
            # some processing here
            return "some data"
    ```

    Parameters: filepath, event_id, uploader_id, tenant_id are REQUIRED!
    Required parameters can be put on self in class like:

    ```py
        class ProcessingClass:

            def __init__(self, event):
                self.event_id = event["event_data"]["event_id"]
                self.uploader_id = event["event_data"]["uploader_id"]
                self.tenant_id = event["event_data"]["tenant_id"]

            @history.log(on_failure_return={})
            def proc_func_within_class(self, filepath):
                print(f"Processing {filepath}...")
                raise Exception("Something bad happened")
                print("Done!")
                return {"k": "v"}
    ```
    Either way if needed parameters will not be found an error will be raised by history.log decorator.

    param: on_success_save - what to save on history logs if function didn't raised any errors
    param: on_failure_save - what to save on history logs if function raised error
    param: on_failure_return - if function raised an error return this instead (for safe processing)
    If you want on failure to return None put it as a string `on_failure_return="None"`
    Ex:
    ```
        @history.log(on_failure_return={})
        def procFunc(*args, **kwargs):
            raise Exception("Failed")

        &gt;&gt; print(procFunc())
        &gt;&gt; {}
    ```

Here is an example on how logging a processing event will look like:

```bash

    {
        _id: ObjectId('6230670a96defb313cf63fa9'),
        uploader_id: 'universal_uploader',
        app_id: 'app',
        event_id: '6cd474cd-663f-4d1f-891e-e18d0d0ea77e',
        tenant_id: 'b37761e3-6926-4cc1-88c7-4d0478b04adf',
        filename_validation: [
            {
                message: 'Filename is valid',
                filename: 'cpuq.txt',
                status: 'success'
            }
        ],
        updated_at: '2022-03-15T10:14:34.470253',
        filename_validation_updated_at: '2022-03-15T10:14:34.411491',
        file_content_validation: [
            {
                message: 'Filename is valid',
                filepath: '/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt',
                filename: 'cpuq.txt',
                status: 'success'
            }
        ],
        file_content_validation_updated_at: '2022-03-15T10:14:34.426705',
        files_uploaded: [
            '/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf_6cd474cd-663f-4d1f-891e-e18d0d0ea77e_2022-04-14/cpuq.txt'
        ],
        processing_details: [
            {
                step: 'Getting some data out of provided cpuq.txt file',
                status: 'success',
                traceback: null,
                error: null,
                callable: 'processing_function',
                success: null,
                source: '/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py',
                updated_at: '2022-03-15T10:14:34.434117',
                filepath: '/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt'
            },
            {
                step: 'Getting some data out of provided cpuq.txt file',
                status: 'success',
                traceback: null,
                error: null,
                callable: 'processing_function_without_decorator',
                success: 'Entities added successfully',
                source: '/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py',
                updated_at: '2022-03-15T10:14:34.454749',
                filepath: '/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt'
            },
            {
                step: 'Getting some data out of provided cpuq.txt file',
                status: 'failed',
                traceback: 'Traceback (most recent call last):
</code></pre>
<p>File "/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py", line 183, in processing_function_without_decorator
raise Exception("Something bad happened")
Exception: Something bad happened
',
error: 'Something bad happened',
callable: 'processing_function_without_decorator',
success: null,
source: '/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py',
updated_at: '2022-03-15T10:14:34.462103',
filepath: '/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt'
},
{
step: 'proc_func_within_class',
status: 'failed',
traceback: 'Traceback (most recent call last):
File "/home/acmt/Documents/lware/licenseware-sdk-v2/licenseware/history/history.py", line 231, in wrapper
response = f(<em>args, </em>*kwargs)
File "/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py", line 219, in proc_func_within_class
raise Exception("Something bad happened")
Exception: Something bad happened
',
error: 'Something bad happened',
callable: 'proc_func_within_class',
success: null,
source: '/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py',
updated_at: '2022-03-15T10:14:34.470259',
filepath: '/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt'
}
],
entities: [
'5a5be275-cee8-44a6-a11c-0e2b886a820e',
'b137ff5d-90f1-4d45-872d-91b617666b78',
'b3d7a18e-7a6d-4296-8fcc-0464ec243658',
'ebaf16c9-4d88-413d-b395-92b65166ab20'
]
}
```</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def log(*dargs, on_success_save: str = None, on_failure_save: str = None, on_failure_return: Any = None):
    &#34;&#34;&#34;
        Log processing events by decorating processing function/methods.

        Usage:
        ```py
            @history.log
            def processing_function(filepath, event_id, uploader_id, tenant_id):
                # some processing here
                return &#34;some data&#34;
        ```

        Parameters: filepath, event_id, uploader_id, tenant_id are REQUIRED!
        Required parameters can be put on self in class like:

        ```py
            class ProcessingClass:

                def __init__(self, event):
                    self.event_id = event[&#34;event_data&#34;][&#34;event_id&#34;]
                    self.uploader_id = event[&#34;event_data&#34;][&#34;uploader_id&#34;]
                    self.tenant_id = event[&#34;event_data&#34;][&#34;tenant_id&#34;]

                @history.log(on_failure_return={})
                def proc_func_within_class(self, filepath):
                    print(f&#34;Processing {filepath}...&#34;)
                    raise Exception(&#34;Something bad happened&#34;)
                    print(&#34;Done!&#34;)
                    return {&#34;k&#34;: &#34;v&#34;}
        ```
        Either way if needed parameters will not be found an error will be raised by history.log decorator.

        param: on_success_save - what to save on history logs if function didn&#39;t raised any errors
        param: on_failure_save - what to save on history logs if function raised error
        param: on_failure_return - if function raised an error return this instead (for safe processing)
        If you want on failure to return None put it as a string `on_failure_return=&#34;None&#34;`
        Ex:
        ```
            @history.log(on_failure_return={})
            def procFunc(*args, **kwargs):
                raise Exception(&#34;Failed&#34;)

            &gt;&gt; print(procFunc())
            &gt;&gt; {}
        ```

    Here is an example on how logging a processing event will look like:

    ```bash

        {
            _id: ObjectId(&#39;6230670a96defb313cf63fa9&#39;),
            uploader_id: &#39;universal_uploader&#39;,
            app_id: &#39;app&#39;,
            event_id: &#39;6cd474cd-663f-4d1f-891e-e18d0d0ea77e&#39;,
            tenant_id: &#39;b37761e3-6926-4cc1-88c7-4d0478b04adf&#39;,
            filename_validation: [
                {
                    message: &#39;Filename is valid&#39;,
                    filename: &#39;cpuq.txt&#39;,
                    status: &#39;success&#39;
                }
            ],
            updated_at: &#39;2022-03-15T10:14:34.470253&#39;,
            filename_validation_updated_at: &#39;2022-03-15T10:14:34.411491&#39;,
            file_content_validation: [
                {
                    message: &#39;Filename is valid&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;,
                    filename: &#39;cpuq.txt&#39;,
                    status: &#39;success&#39;
                }
            ],
            file_content_validation_updated_at: &#39;2022-03-15T10:14:34.426705&#39;,
            files_uploaded: [
                &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf_6cd474cd-663f-4d1f-891e-e18d0d0ea77e_2022-04-14/cpuq.txt&#39;
            ],
            processing_details: [
                {
                    step: &#39;Getting some data out of provided cpuq.txt file&#39;,
                    status: &#39;success&#39;,
                    traceback: null,
                    error: null,
                    callable: &#39;processing_function&#39;,
                    success: null,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.434117&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                },
                {
                    step: &#39;Getting some data out of provided cpuq.txt file&#39;,
                    status: &#39;success&#39;,
                    traceback: null,
                    error: null,
                    callable: &#39;processing_function_without_decorator&#39;,
                    success: &#39;Entities added successfully&#39;,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.454749&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                },
                {
                    step: &#39;Getting some data out of provided cpuq.txt file&#39;,
                    status: &#39;failed&#39;,
                    traceback: &#39;Traceback (most recent call last):\n  File &#34;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#34;, line 183, in processing_function_without_decorator\n    raise Exception(&#34;Something bad happened&#34;)\nException: Something bad happened\n&#39;,
                    error: &#39;Something bad happened&#39;,
                    callable: &#39;processing_function_without_decorator&#39;,
                    success: null,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.462103&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                },
                {
                    step: &#39;proc_func_within_class&#39;,
                    status: &#39;failed&#39;,
                    traceback: &#39;Traceback (most recent call last):\n  File &#34;/home/acmt/Documents/lware/licenseware-sdk-v2/licenseware/history/history.py&#34;, line 231, in wrapper\n    response = f(*args, **kwargs)\n  File &#34;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#34;, line 219, in proc_func_within_class\n    raise Exception(&#34;Something bad happened&#34;)\nException: Something bad happened\n&#39;,
                    error: &#39;Something bad happened&#39;,
                    callable: &#39;proc_func_within_class&#39;,
                    success: null,
                    source: &#39;/home/acmt/Documents/lware/licenseware-sdk-v2/tests/test_history.py&#39;,
                    updated_at: &#39;2022-03-15T10:14:34.470259&#39;,
                    filepath: &#39;/tmp/lware/b37761e3-6926-4cc1-88c7-4d0478b04adf/cpuq.txt&#39;
                }
            ],
            entities: [
                &#39;5a5be275-cee8-44a6-a11c-0e2b886a820e&#39;,
                &#39;b137ff5d-90f1-4d45-872d-91b617666b78&#39;,
                &#39;b3d7a18e-7a6d-4296-8fcc-0464ec243658&#39;,
                &#39;ebaf16c9-4d88-413d-b395-92b65166ab20&#39;
            ]
        }
    ```

    &#34;&#34;&#34;
    def _decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            print(f&#34;History kwargs: on_success_save:{on_success_save}, on_failure_save:{on_failure_save}, on_failure_return:{on_failure_return}&#34;)
            # Handle case where files are uploaded and event_id is not provided in the query params
            if f.__name__ == &#39;upload_files&#39; and len(args) &gt; 1:
                if hasattr(args[1], &#34;args&#34;):
                    if args[1].args.get(&#34;event_id&#34;) is None:
                        logg.info(&#34;event_id not provided from frontend.\nUpdated with `event_id`.&#34;)
                        kwargs.update({&#34;event_id&#34;: str(uuid.uuid4())})

            metadata = get_metadata(f, args, kwargs)
            try:
                response = f(*args, **kwargs)
                save_step(metadata, response, on_success_save, on_failure_save)
                response = add_event_id_to_payload(metadata, response)
                return response
            except Exception as err:

                save_step(metadata, {
                    &#39;error&#39;: str(err),
                    &#39;traceback&#39;: str(traceback.format_exc())
                }, on_success_save, on_failure_save, True)

                if on_failure_return is not None:
                    return on_failure_return
                elif on_failure_return == &#34;None&#34;:
                    return None
                else:
                    logg.exception(err)
                    raise err

        return wrapper
    return _decorator(dargs[0]) if dargs and callable(dargs[0]) else _decorator</code></pre>
</details>
</dd>
<dt id="licenseware.history.history.log_failure"><code class="name flex">
<span>def <span class="ident">log_failure</span></span>(<span>func: <built-in function callable>, tenant_id: str, event_id: str, uploader_id: str, filepath: str, error_string: str, traceback_string: str, on_failure_save: str = None, **overflow)</span>
</code></dt>
<dd>
<div class="desc"><p>Log in history a processing failure event.
Usage:</p>
<pre><code class="language-py">    def processing_func(*args, **kwargs):
        # some processing here
        try:
            raise Exception(&quot;Something bad happened&quot;)
        except Exception as error:
            history.log_failure(
                func=processing_func, # for classes use self.func
                tenant_id=tenant_id,
                event_id=event_id,
                uploader_id=uploader_id,
                filepath=filepath,
                error_string=str(error),
                traceback_string=str(traceback.format_exc())
            )
        # some processing here
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def log_failure(
        func: callable,
        tenant_id: str,
        event_id: str,
        uploader_id: str,
        filepath: str,
        error_string: str,
        traceback_string: str,
        on_failure_save: str = None,
        **overflow
):
    &#34;&#34;&#34;
    Log in history a processing failure event.
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            # some processing here
            try:
                raise Exception(&#34;Something bad happened&#34;)
            except Exception as error:
                history.log_failure(
                    func=processing_func, # for classes use self.func
                    tenant_id=tenant_id,
                    event_id=event_id,
                    uploader_id=uploader_id,
                    filepath=filepath,
                    error_string=str(error),
                    traceback_string=str(traceback.format_exc())
                )
            # some processing here
    ```

    &#34;&#34;&#34;

    func_name = func.__name__
    step = func.__doc__.strip() if func.__doc__ else func.__name__
    func_source = str(inspect.getmodule(func)).split(&#34;from&#34;)[1].strip().replace(&#34;&#39;&#34;, &#34;&#34;).replace(&#34;&gt;&#34;, &#34;&#34;)

    metadata = create_metadata(step, tenant_id, event_id, uploader_id, filepath, func_name, func_source)
    save_step(metadata, {
        &#39;error&#39;: error_string,
        &#39;traceback&#39;: traceback_string
    }, None, on_failure_save, True)
    return metadata</code></pre>
</details>
</dd>
<dt id="licenseware.history.history.log_success"><code class="name flex">
<span>def <span class="ident">log_success</span></span>(<span>func: <built-in function callable>, tenant_id: str, event_id: str, uploader_id: str, filepath: str, on_success_save: str = None, **overflow)</span>
</code></dt>
<dd>
<div class="desc"><p>Log in history a processing success event.
Usage:</p>
<pre><code class="language-py">    def processing_func(*args, **kwargs):
        # some processing here
        history.log_success(
            func=processing_func,  # for classes use self.func
            tenant_id=tenant_id,
            event_id=event_id,
            uploader_id=uploader_id,
            filepath=filepath,
            on_success_save=&quot;Entities added successfully&quot;
        )
        # some processing here
</code></pre></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def log_success(
        func: callable,
        tenant_id: str,
        event_id: str,
        uploader_id: str,
        filepath: str,
        on_success_save: str = None,
        **overflow
):
    &#34;&#34;&#34;
    Log in history a processing success event.
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            # some processing here
            history.log_success(
                func=processing_func,  # for classes use self.func
                tenant_id=tenant_id,
                event_id=event_id,
                uploader_id=uploader_id,
                filepath=filepath,
                on_success_save=&#34;Entities added successfully&#34;
            )
            # some processing here
    ```
    &#34;&#34;&#34;
    func_name = func.__name__
    step = func.__doc__.strip() if func.__doc__ else func.__name__
    func_source = str(inspect.getmodule(func)).split(&#34;from&#34;)[1].strip().replace(&#34;&#39;&#34;, &#34;&#34;).replace(&#34;&gt;&#34;, &#34;&#34;)

    metadata = create_metadata(step, tenant_id, event_id, uploader_id, filepath, func_name, func_source)
    save_step(metadata, None, on_success_save, None)
    return metadata</code></pre>
</details>
</dd>
<dt id="licenseware.history.history.remove_entities"><code class="name flex">
<span>def <span class="ident">remove_entities</span></span>(<span>event_id: str, entities: list = None)</span>
</code></dt>
<dd>
<div class="desc"><p>Remove reference ids to entities like databases, devices etc from history
Usage:</p>
<pre><code class="language-py">    def processing_func(*args, **kwargs):
        entity_id1, entity_id2 = get_some_entities()
        history.add_entities(event_id, entities=[entity_id1, entity_id2])
</code></pre>
<p>Where <code>entity_idx</code> is an uuid4 string.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def remove_entities(
        event_id: str,
        entities: list = None
):
    &#34;&#34;&#34;
    Remove reference ids to entities like databases, devices etc from history
    Usage:
    ```py
        def processing_func(*args, **kwargs):
            entity_id1, entity_id2 = get_some_entities()
            history.add_entities(event_id, entities=[entity_id1, entity_id2])
    ```
    Where `entity_idx` is an uuid4 string.

    &#34;&#34;&#34;
    with collection(envs.MONGO_COLLECTION_HISTORY_NAME) as col:
        col: Collection
        updated = col.update_one(
            filter={&#39;event_id&#39;: event_id},
            update={&#39;$pull&#39;: {&#39;entities&#39;: {&#34;$in&#34;: entities}}}
        ).modified_count

    return updated</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="licenseware.history" href="index.html">licenseware.history</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="licenseware.history.history.add_entities" href="#licenseware.history.history.add_entities">add_entities</a></code></li>
<li><code><a title="licenseware.history.history.log" href="#licenseware.history.history.log">log</a></code></li>
<li><code><a title="licenseware.history.history.log_failure" href="#licenseware.history.history.log_failure">log_failure</a></code></li>
<li><code><a title="licenseware.history.history.log_success" href="#licenseware.history.history.log_success">log_success</a></code></li>
<li><code><a title="licenseware.history.history.remove_entities" href="#licenseware.history.history.remove_entities">remove_entities</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>